<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registrar baja de herramientas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f4f6f8;
            color: #333;
        }

        .page-wrapper {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Logo y título */
        .logo-container {
            text-align: center;
            margin-bottom: 10px;
        }
        .logo-container img {
            height: 40px;
            width: auto;
        }

        h1 {
            text-align: center;
            margin: 10px 0 25px 0;
            font-size: 2rem;
            color: #222;
        }

        /* Link volver */
        .btn-volver {
            text-decoration: none;
            display: inline-block;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #e03131;
            font-weight: 600;
        }
        .btn-volver::before {
            content: "← ";
        }
        .btn-volver:hover {
            text-decoration: underline;
        }

        /* Mensajes */
        .ok, .error {
            padding: 10px 12px;
            margin-bottom: 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            border: 1px solid transparent;
        }
        .ok {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        /* Layout principal */
        .layout {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }
        .col-left {
            flex: 1.2;
        }
        .col-right {
            flex: 1;
        }

        /* Tarjetas */
        .card {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 3px 6px rgba(15, 23, 42, 0.08);
            padding: 18px 20px 20px 20px;
            margin-bottom: 18px;
        }
        .card-header {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e03131;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-header span {
            color: #222;
        }

        .card-subtext {
            font-size: 0.85rem;
            color: #666;
        }

        .grupo {
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            color: #444;
        }

        input[type="text"],
        input[type="date"],
        input[type="time"],
        input[type="number"],
        select,
        textarea {
            font-family: inherit;
            font-size: 0.9rem;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #d0d7de;
            background-color: #fdfdfd;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s, background-color 0.2s;
        }

        input[type="text"]:focus,
        input[type="date"]:focus,
        input[type="time"]:focus,
        input[type="number"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #e03131;
            box-shadow: 0 0 0 2px rgba(224, 49, 49, 0.15);
            background-color: #ffffff;
        }

        input[readonly] {
            background-color: #f3f4f6;
            color: #555;
        }

        textarea {
            resize: vertical;
            min-height: 70px;
        }

        .info-prestamo {
            font-size: 0.8rem;
            color: #555;
            margin-top: 5px;
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px dashed #d0d7de;
            background-color: #f9fafb;
        }

        .ayuda {
            font-size: 0.8rem;
            color: #888;
        }

        /* Tabla herramientas */
        .tabla-wrapper {
            margin-top: 10px;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #e1e4e8;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.9rem;
        }

        thead {
            background: #f5f7fb;
        }

        th, td {
            padding: 8px 10px;
            border-bottom: 1px solid #e1e4e8;
            text-align: left;
        }

        th {
            font-weight: 600;
            color: #444;
            white-space: nowrap;
        }

        tbody tr:nth-child(even) {
            background-color: #fafbfc;
        }

        tbody tr:hover {
            background-color: #f1f5f9;
        }

        .cantidad-input {
            width: 90px;
        }

        /* Botones */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            border: none;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            padding: 9px 16px;
            transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
        }

        .btn-primary {
            background: #e03131;
            color: #fff;
            box-shadow: 0 2px 4px rgba(224, 49, 49, 0.35);
        }
        .btn-primary:hover {
            background: #c92a2a;
            transform: translateY(-1px);
        }

        @media (max-width: 900px) {
            .layout {
                flex-direction: column;
            }
            .col-left, .col-right {
                flex: none;
                width: 100%;
            }
        }
    </style>
</head>
<body>
<div class="page-wrapper">

    <!-- Logo y título -->
    <div class="logo-container">
        <!-- cambia la URL del logo al que uses en el resto del sistema -->
        <img src="https://afeva.cl/wp-content/uploads/bfi_thumb/logo-02-3de0hedts90kzsj5so5p6cawzz6fhdkja52f67wjd5s94pl8w.png"
             alt="Logo INACAP">
    </div>

    <h1>Registrar baja de herramientas</h1>

    <a href="{% url 'menu_principal' %}" class="btn-volver">Volver al menú</a>

    {% if mensaje %}
        <div class="ok">{{ mensaje }}</div>
    {% endif %}

    {% if error %}
        <div class="error">{{ error }}</div>
    {% endif %}

    <form method="POST" id="form-baja">
        {% csrf_token %}

        <div class="layout">
            <!-- COLUMNA IZQUIERDA: CONTEXTO + DESCRIPCIÓN -->
            <div class="col-left">

                <div class="card">
                    <div class="card-header">
                        <span>Contexto de la baja</span>
                    </div>

                    <div class="grupo">
                        <label>Pañolero:</label>
                        <div><strong>{{ panolero.nombre }}</strong></div>
                    </div>

                    <div class="grupo">
                        <label for="codigo_prestamo_ctx">Código de préstamo ref.:</label>
                        <input type="text"
                               name="codigo_prestamo_ctx"
                               id="codigo_prestamo_ctx"
                               placeholder="Ej: P20251125140727"
                               style="max-width: 260px;">
                        <div class="ayuda">
                            Al cargar un préstamo se llenan automáticamente las herramientas de abajo.
                        </div>
                    </div>

                    <div id="info_prestamo" class="info-prestamo"></div>

                    <div class="grupo">
                        <label for="docente_select">Docente:</label>
                        <select name="docente_codigo" id="docente_select">
                            <option value="">-- Sin docente / no aplica --</option>
                            {% for d in docentes %}
                            <option value="{{ d.codigo }}">{{ d.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="grupo">
                        <label>Estudiante (nombre):</label>
                        <input type="text"
                               id="estudiante_nombre"
                               readonly>
                    </div>

                    <div class="grupo">
                        <label>RUT estudiante:</label>
                        <input type="text"
                               id="estudiante_rut"
                               readonly>
                    </div>

                    <div class="grupo">
                        <label>Carrera estudiante:</label>
                        <input type="text"
                               id="estudiante_carrera"
                               readonly>
                    </div>

                    <div class="grupo">
                        <label for="asignatura_nombre">Asignatura:</label>
                        <input type="text"
                               name="asignatura_nombre"
                               id="asignatura_nombre"
                               placeholder="Ej: Taller de Estructuras">
                    </div>

                    <div class="grupo">
                        <label for="fecha_clase">Fecha actividad:</label>
                        <input type="date" name="fecha_clase" id="fecha_clase">
                    </div>

                    <div class="grupo">
                        <label for="hora_inicio_clase">Hora inicio actividad:</label>
                        <input type="time" name="hora_inicio_clase" id="hora_inicio_clase">
                    </div>

                    <div class="grupo">
                        <label for="hora_fin_clase">Hora término actividad:</label>
                        <input type="time" name="hora_fin_clase" id="hora_fin_clase">
                        <div class="ayuda">
                            Se guarda luego como texto dentro de las observaciones.
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span>Descripción de la baja</span>
                    </div>

                    <div class="grupo">
                        <label for="motivo_general">Motivo general:</label>
                        <input type="text"
                               name="motivo_general"
                               id="motivo_general"
                               placeholder="Ej: Rotura por accidente en taller, pérdida por error, etc.">
                    </div>

                    <div class="grupo">
                        <label for="observaciones">Observaciones (opcional):</label>
                        <textarea name="observaciones" id="observaciones" rows="3"></textarea>
                    </div>
                </div>

            </div>

            <!-- COLUMNA DERECHA: HERRAMIENTAS -->
            <div class="col-right">
                <div class="card">
                    <div class="card-header">
                        <span>Herramientas a dar de baja</span>
                    </div>
                    <p class="card-subtext">
                        Escanea o escribe el código en la columna <strong>"Código"</strong>. Si cargaste
                        un préstamo, las herramientas aparecerán ya rellenadas con cantidades prestadas
                        y devueltas. Indica la <strong>cantidad a dar de baja</strong> para cada ítem.
                    </p>

                    <div class="tabla-wrapper">
                        <table id="tabla_bajas">
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Herramienta</th>
                                    <th>Prestada</th>
                                    <th>Devuelta</th>
                                    <th>Stock disp. actual</th>
                                    <th>Cantidad de baja</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for i in "01234567890123456789" %}
                                <tr>
                                    <td>
                                        <input type="text"
                                               name="codigo_herramienta"
                                               class="codigo-input"
                                               data-row="{{ forloop.counter0 }}">
                                    </td>
                                    <td>
                                        <input type="text"
                                               class="nombre-input"
                                               data-row="{{ forloop.counter0 }}"
                                               readonly>
                                    </td>
                                    <td>
                                        <input type="text"
                                               class="prestada-input"
                                               data-row="{{ forloop.counter0 }}"
                                               readonly>
                                    </td>
                                    <td>
                                        <input type="text"
                                               class="devuelta-input"
                                               data-row="{{ forloop.counter0 }}"
                                               readonly>
                                    </td>
                                    <td>
                                        <input type="text"
                                               class="stock-input"
                                               data-row="{{ forloop.counter0 }}"
                                               readonly>
                                    </td>
                                    <td>
                                        <input type="number"
                                               name="cantidad_baja"
                                               class="cantidad-input"
                                               data-row="{{ forloop.counter0 }}"
                                               value="0"
                                               min="0">
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div style="margin-top: 16px; text-align: right;">
                        <button type="submit" class="btn btn-primary">Registrar bajas</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// Evitar que ENTER envíe el formulario completo
document.getElementById("form-baja").addEventListener("keydown", function(e) {
    if (e.key === "Enter" && e.target.tagName.toLowerCase() !== "textarea") {
        e.preventDefault();
    }
});

// -------------------------
// Limpia contexto de préstamo
// -------------------------
function limpiarContextoPrestamo() {
    document.getElementById("info_prestamo").textContent = "";

    const selDoc = document.getElementById("docente_select");
    if (selDoc) selDoc.value = "";

    document.getElementById("asignatura_nombre").value = "";
    document.getElementById("fecha_clase").value = "";
    document.getElementById("hora_inicio_clase").value = "";
    document.getElementById("hora_fin_clase").value = "";

    document.getElementById("estudiante_nombre").value = "";
    document.getElementById("estudiante_rut").value = "";
    document.getElementById("estudiante_carrera").value = "";

    const codigos  = Array.from(document.querySelectorAll(".codigo-input"));
    const nombres  = Array.from(document.querySelectorAll(".nombre-input"));
    const prestada = Array.from(document.querySelectorAll(".prestada-input"));
    const devuelta = Array.from(document.querySelectorAll(".devuelta-input"));
    const stock    = Array.from(document.querySelectorAll(".stock-input"));
    const cants    = Array.from(document.querySelectorAll(".cantidad-input"));

    for (let i = 0; i < codigos.length; i++) {
        codigos[i].value  = "";
        nombres[i].value  = "";
        stock[i].value    = "";
        cants[i].value    = "0";
        cants[i].removeAttribute("max");
        if (prestada[i]) prestada[i].value = "";
        if (devuelta[i]) devuelta[i].value = "";
    }
}

// -------------------------
// Cargar préstamo por código
// -------------------------
function cargarPrestamoPorCodigo(codigo) {
    if (!codigo) {
        limpiarContextoPrestamo();
        return;
    }

    fetch(`/prestamos/api/?codigo=${encodeURIComponent(codigo)}`)
        .then(r => r.json())
        .then(data => {
            if (!data.ok) {
                alert(data.error || "No se encontró el préstamo.");
                limpiarContextoPrestamo();
                return;
            }

            const infoDiv = document.getElementById("info_prestamo");
            infoDiv.textContent =
                `Préstamo ${data.codigo_prestamo} | ` +
                `Pañolero: ${data.panolero_nombre || "-"} | ` +
                `Docente: ${data.docente_nombre || "-"} | ` +
                `Estudiante: ${data.estudiante_nombre || "-"}`;

            const selDoc = document.getElementById("docente_select");
            if (selDoc && data.docente_codigo) {
                selDoc.value = data.docente_codigo.toString();
            }

            const inpAsig = document.getElementById("asignatura_nombre");
            if (inpAsig) {
                inpAsig.value = data.asignatura_nombre || "";
            }

            const fAct = document.getElementById("fecha_clase");
            if (fAct && data.fecha) {
                fAct.value = data.fecha;
            }

            const hIni = document.getElementById("hora_inicio_clase");
            if (hIni && data.hora_inicio) {
                hIni.value = data.hora_inicio;
            }

            const hFin = document.getElementById("hora_fin_clase");
            if (hFin && data.hora_fin) {
                hFin.value = data.hora_fin;
            }

            document.getElementById("estudiante_nombre").value =
                data.estudiante_nombre || "";
            document.getElementById("estudiante_rut").value =
                data.estudiante_rut || "";
            document.getElementById("estudiante_carrera").value =
                data.estudiante_carrera || "";

            const codigos  = Array.from(document.querySelectorAll(".codigo-input"));
            const nombres  = Array.from(document.querySelectorAll(".nombre-input"));
            const prestada = Array.from(document.querySelectorAll(".prestada-input"));
            const devuelta = Array.from(document.querySelectorAll(".devuelta-input"));
            const stock    = Array.from(document.querySelectorAll(".stock-input"));
            const cants    = Array.from(document.querySelectorAll(".cantidad-input"));

            for (let i = 0; i < codigos.length; i++) {
                codigos[i].value  = "";
                nombres[i].value  = "";
                stock[i].value    = "";
                cants[i].value    = "0";
                cants[i].removeAttribute("max");
                if (prestada[i]) prestada[i].value = "";
                if (devuelta[i]) devuelta[i].value = "";
            }

            if (Array.isArray(data.detalles)) {
                data.detalles.forEach((det, idx) => {
                    if (idx >= codigos.length) return;

                    const codInput      = codigos[idx];
                    const prestadaInput = prestada[idx];
                    const devueltaInput = devuelta[idx];
                    const cantInput     = cants[idx];

                    codInput.value = det.codigo || "";

                    if (prestadaInput) {
                        prestadaInput.value = det.cantidad_entregada ?? "";
                    }
                    if (devueltaInput) {
                        devueltaInput.value = det.cantidad_devuelta ?? "";
                    }

                    buscarHerramientaPorCodigo(codInput, false);

                    const cantPrestada = det.cantidad_entregada || 0;
                    const cantDevuelta = det.cantidad_devuelta || 0;
                    const maxPosible = Math.max(0, cantPrestada - cantDevuelta);
                    if (maxPosible > 0) {
                        cantInput.max = maxPosible;
                    }
                });
            }
        })
        .catch(err => {
            console.error(err);
            alert("Ocurrió un error al buscar el préstamo.");
            limpiarContextoPrestamo();
        });
}

const codPrestamoInput = document.getElementById("codigo_prestamo_ctx");
codPrestamoInput.addEventListener("blur", function() {
    cargarPrestamoPorCodigo(this.value.trim());
});
codPrestamoInput.addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
        e.preventDefault();
        cargarPrestamoPorCodigo(this.value.trim());
    }
});

// -------------------------
// Búsqueda de herramientas
// -------------------------
function moverFocoSiguienteCodigo(inputActual) {
    const codigos = Array.from(document.querySelectorAll(".codigo-input"));
    const idx = codigos.indexOf(inputActual);
    if (idx !== -1 && idx + 1 < codigos.length) {
        const siguiente = codigos[idx + 1];
        siguiente.focus();
        siguiente.select();
    }
}

function buscarHerramientaPorCodigo(inputCodigo, moverFoco) {
    const codigo = inputCodigo.value.trim();
    const row = inputCodigo.dataset.row;

    const nombreInput   = document.querySelector('.nombre-input[data-row="' + row + '"]');
    const stockInput    = document.querySelector('.stock-input[data-row="' + row + '"]');
    const cantInput     = document.querySelector('.cantidad-input[data-row="' + row + '"]');

    if (!codigo) {
        nombreInput.value = "";
        stockInput.value = "";
        return;
    }

    fetch(`/inventario/api/herramienta/?codigo=${encodeURIComponent(codigo)}`)
        .then(r => r.json())
        .then(data => {
            if (data.ok) {
                nombreInput.value = data.nombre;
                stockInput.value  = data.stock_disponible;

                let actual = parseInt(cantInput.value || "0", 10);
                if (actual < 0) {
                    cantInput.value = 0;
                }

                if (moverFoco) {
                    moverFocoSiguienteCodigo(inputCodigo);
                }
            } else {
                nombreInput.value = "No encontrado";
                stockInput.value = "";
            }
        })
        .catch(err => {
            console.error(err);
            nombreInput.value = "Error al buscar";
            stockInput.value = "";
        });
}

// Eventos para códigos
document.querySelectorAll(".codigo-input").forEach((input) => {
    input.addEventListener("blur", function() {
        buscarHerramientaPorCodigo(this, false);
    });

    input.addEventListener("keydown", function(e) {
        if (e.key === "Enter") {
            e.preventDefault();
            buscarHerramientaPorCodigo(this, true);
        }
    });
});
</script>

</body>
</html>
