<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de KPIs - Pañol</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f5f5f5;
        }

        header {
            background-color: #1f2933;
            color: #fff;
            padding: 15px 25px;
        }

        header h1 {
            margin: 0;
            font-size: 1.4rem;
        }

        header .subtitulo {
            margin-top: 4px;
            font-size: 0.9rem;
            color: #d1d5db;
        }

        .contenedor {
            padding: 20px 25px 30px 25px;
        }

        .barra-superior {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 6px 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .btn-secundario {
            background-color: #6c757d;
            color: #fff;
        }

        .btn-secundario:hover {
            opacity: 0.9;
        }

        .btn-exportar {
            margin-right: 6px;
        }

        /* Filtros */
        form.filtros {
            display: flex;
            flex-wrap: wrap;
            gap: 10px 20px;
            align-items: center;
            background-color: #ffffff;
            padding: 10px 15px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        form.filtros label {
            font-size: 0.85rem;
            font-weight: bold;
        }

        form.filtros select {
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 0.85rem;
            min-width: 140px;
        }

        form.filtros button {
            padding: 6px 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            background-color: #2563eb;
            color: #fff;
        }

        form.filtros button:hover {
            opacity: 0.95;
        }

        /* KPIs tarjetas */
        .kpis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .kpi-card {
            background-color: #ffffff;
            border-radius: 6px;
            padding: 10px 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .kpi-label {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .kpi-valor {
            font-size: 1.4rem;
            font-weight: bold;
            color: #111827;
            margin-top: 4px;
        }

        .kpi-extra {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 4px;
        }

        /* Zona de gráficos */
        .grid-graficos {
            display: grid;
            grid-template-columns: minmax(260px, 1.2fr) minmax(260px, 1.4fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        .card-grafico {
            background-color: #ffffff;
            border-radius: 6px;
            padding: 10px 12px 15px 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .card-grafico h2 {
            margin: 0 0 6px 0;
            font-size: 1rem;
            color: #111827;
        }

        .card-grafico .descripcion {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 10px;
        }

        .selector-ranking {
            margin-bottom: 10px;
            font-size: 0.8rem;
        }

        .selector-ranking select {
            padding: 3px 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 0.8rem;
        }

        /* Tabla de préstamos */
        .seccion-tabla {
            margin-top: 10px;
        }

        .seccion-tabla h2 {
            margin: 0 0 8px 0;
            font-size: 1.0rem;
            color: #111827;
        }

        .seccion-tabla .descripcion {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 6px;
        }

        .tabla-contenedor {
            background-color: #ffffff;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            overflow-x: auto;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.8rem;
        }

        th, td {
            padding: 6px 8px;
            border: 1px solid #e5e7eb;
            text-align: left;
        }

        th {
            background-color: #f3f4f6;
            font-weight: bold;
        }

        tr:nth-child(even) {
            background-color: #f9fafb;
        }

        .badge-estado {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .estado-pendiente {
            background-color: #fef3c7;
            color: #92400e;
        }

        .estado-devuelto {
            background-color: #d1fae5;
            color: #065f46;
        }

        .estado-parcial {
            background-color: #e0f2fe;
            color: #1d4ed8;
        }

        .sin-datos {
            padding: 8px;
            text-align: center;
            font-style: italic;
            color: #6b7280;
        }

        @media (max-width: 900px) {
            .grid-graficos {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            .barra-superior {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            form.filtros {
                flex-direction: column;
                align-items: flex-start;
            }

            form.filtros select {
                min-width: 180px;
            }
        }
    </style>
</head>
<body>

<header>
    <h1>Panel de KPIs del Pañol</h1>
    <div class="subtitulo">
        Gráficos dinámicos de uso de herramientas según semestre, carrera, asignatura y pañolero.
    </div>
</header>

<div class="contenedor">

    <div class="barra-superior">
        <div>
            <form method="get" action="{% url 'exportar_panel_kpis' %}" style="display:inline-block;">
                <input type="hidden" name="semestre" value="{{ semestre_sel }}">
                <input type="hidden" name="carrera" value="{{ carrera_sel }}">
                <input type="hidden" name="asignatura" value="{{ asignatura_sel }}">

                <button class="btn btn-secundario btn-exportar" type="submit" name="formato" value="excel">
                    Descargar Excel
                </button>
                <button class="btn btn-secundario btn-exportar" type="submit" name="formato" value="pdf">
                    Descargar PDF
                </button>
            </form>
        </div>

        <div>
            <button class="btn btn-secundario" type="button"
                    onclick="window.location.href='/'">
                Volver al menú principal
            </button>
        </div>
    </div>

    <!-- Filtros -->
    <form method="get" class="filtros">
        <div>
            <label for="id_semestre">Semestre:</label><br>
            <select name="semestre" id="id_semestre">
                <option value="">Todos</option>
                {% for s in lista_semestres %}
                    <option value="{{ s }}" {% if s == semestre_sel %}selected{% endif %}>
                        {{ s }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label for="id_carrera">Carrera (estudiante):</label><br>
            <select name="carrera" id="id_carrera">
                <option value="">Todas</option>
                {% for c in lista_carreras %}
                    <option value="{{ c }}" {% if c == carrera_sel %}selected{% endif %}>
                        {{ c }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label for="id_asignatura">Asignatura:</label><br>
            <select name="asignatura" id="id_asignatura">
                <option value="">Todas</option>
                {% for a in lista_asignaturas %}
                    <option value="{{ a }}" {% if a == asignatura_sel %}selected{% endif %}>
                        {{ a }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div>
            <button type="submit">Aplicar filtros</button>
        </div>
    </form>

    <!-- KPIs -->
    <div class="kpis">
        <div class="kpi-card">
            <div class="kpi-label">Total de préstamos</div>
            <div class="kpi-valor">{{ total_prestamos }}</div>
            <div class="kpi-extra">Préstamos encontrados con los filtros actuales.</div>
        </div>

        <div class="kpi-card">
            <div class="kpi-label">Herramientas entregadas</div>
            <div class="kpi-valor">{{ total_herramientas }}</div>
            <div class="kpi-extra">Suma de cantidades entregadas en todos los préstamos.</div>
        </div>

        <div class="kpi-card">
            <div class="kpi-label">Préstamos a docentes</div>
            <div class="kpi-valor">{{ total_prest_docente }}</div>
            <div class="kpi-extra">Número de préstamos con solicitante docente.</div>
        </div>

        <div class="kpi-card">
            <div class="kpi-label">Préstamos a estudiantes</div>
            <div class="kpi-valor">{{ total_prest_estudiante }}</div>
            <div class="kpi-extra">Número de préstamos con solicitante estudiante.</div>
        </div>

        <!-- NUEVO KPI: pañoleros -->
        <div class="kpi-card">
            <div class="kpi-label">Pañoleros activos</div>
            <div class="kpi-valor">{{ total_panoleros }}</div>
            <div class="kpi-extra">Pañoleros que registraron préstamos en el periodo.</div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="grid-graficos">
        <div class="card-grafico">
            <h2>Distribución por tipo de solicitante</h2>
            <div class="descripcion">
                Comparación de préstamos generados por docentes, estudiantes y otros.
            </div>
            <canvas id="chartSolicitantes" height="200"></canvas>
        </div>

        <div class="card-grafico">
            <h2>Ranking dinámico</h2>
            <div class="descripcion">
                Cambia el tipo de ranking para ver los top 5 según el criterio seleccionado.
            </div>

            <div class="selector-ranking">
                <label for="tipoRanking">Ver ranking de: </label>
                <select id="tipoRanking">
                    <option value="docentes">Docentes (cantidad de préstamos)</option>
                    <option value="carreras">Carreras (préstamos a estudiantes)</option>
                    <option value="herramientas">Herramientas (cantidad entregada)</option>
                    <option value="asignaturas">Asignaturas / Laboratorio</option>
                    <option value="autos">Llaves de auto / vehículos</option>
                    <!-- NUEVO: ranking de pañoleros -->
                    <option value="panoleros">Pañoleros (préstamos registrados)</option>
                </select>
            </div>

            <canvas id="chartRanking" height="200"></canvas>
        </div>
    </div>

    <!-- Tabla -->
    <div class="seccion-tabla">
        <h2>Listado de préstamos en el periodo</h2>
        <div class="descripcion">
            Resumen de todos los préstamos que cumplen los filtros seleccionados.
        </div>
        <div class="tabla-contenedor">
            {% if prestamos %}
            <table>
                <thead>
                    <tr>
                        <th>Código</th>
                        <th>Fecha</th>
                        <th>Hora inicio</th>
                        <th>Hora fin</th>
                        <th>Solicitante</th>
                        <th>Asignatura</th>
                        <th>Pañolero</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in prestamos %}
                    <tr>
                        <td>{{ p.codigo_prestamo }}</td>
                        <td>{{ p.fecha }}</td>
                        <td>{{ p.hora_inicio|default:"-" }}</td>
                        <td>{{ p.hora_fin|default:"-" }}</td>
                        <td>
                            {% if p.docente %}
                                {{ p.docente.nombre }} (Docente)
                            {% elif p.estudiante %}
                                {{ p.estudiante.nombre }} ({{ p.estudiante.carrera }})
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if p.asignatura %}
                                {{ p.asignatura.nombre }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if p.panolero %}
                                {{ p.panolero.nombre }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge-estado
                                {% if p.estado == 'pendiente' %}estado-pendiente
                                {% elif p.estado == 'devuelto' %}estado-devuelto
                                {% else %}estado-parcial
                                {% endif %}">
                                {{ p.estado }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="sin-datos">
                No hay préstamos registrados con los filtros actuales.
            </div>
            {% endif %}
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // ---------------- DATOS DESDE DJANGO ----------------
    // Distribución por tipo de solicitante
    const totalDocentes = {{ total_prest_docente|default:0 }};
    const totalEstudiantes = {{ total_prest_estudiante|default:0 }};
    const totalOtros = {{ total_prest_otros|default:0 }};

    // Top docentes
    const labelsDocentes = [
        {% for d in top_docentes %}
            "{{ d.docente__nombre|escapejs }}"{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    const dataDocentes = [
        {% for d in top_docentes %}
            {{ d.total_prestamos }}{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    // Top carreras
    const labelsCarreras = [
        {% for c in top_carreras %}
            "{{ c.estudiante__carrera|escapejs }}"{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    const dataCarreras = [
        {% for c in top_carreras %}
            {{ c.total_prestamos }}{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    // Top herramientas
    const labelsHerramientas = [
        {% for h in top_herramientas %}
            "{{ h.herramienta__nombre|escapejs }}"{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    const dataHerramientas = [
        {% for h in top_herramientas %}
            {{ h.total_cant }}{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    // Top asignaturas
    const labelsAsignaturas = [
        {% for a in top_asignaturas %}
            "{{ a.asignatura__nombre|escapejs }}"{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    const dataAsignaturas = [
        {% for a in top_asignaturas %}
            {{ a.total_prestamos }}{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    // Top autos
    const labelsAutos = [
        {% for au in top_autos %}
            "{{ au.herramienta__nombre|escapejs }}"{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    const dataAutos = [
        {% for au in top_autos %}
            {{ au.total_prestamos }}{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    // NUEVO: Top pañoleros
    const labelsPanoleros = [
        {% for p in top_panoleros %}
            "{{ p.panolero__nombre|escapejs }}"{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    const dataPanoleros = [
        {% for p in top_panoleros %}
            {{ p.total_prestamos }}{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    // ---------------- GRÁFICO PIE: solicitantes ----------------
    const ctxPie = document.getElementById('chartSolicitantes').getContext('2d');
    const chartSolicitantes = new Chart(ctxPie, {
        type: 'pie',
        data: {
            labels: ['Docentes', 'Estudiantes', 'Otros'],
            datasets: [{
                data: [totalDocentes, totalEstudiantes, totalOtros],
                backgroundColor: ['#2563eb', '#f59e0b', '#6b7280'],
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    enabled: true
                },
                title: {
                    display: false
                }
            }
        }
    });

    // ---------------- GRÁFICO BARRAS DINÁMICO: ranking ----------------
    const ctxRanking = document.getElementById('chartRanking').getContext('2d');
    
    function getBarColors(count) {
        const colors = [];
        for (let i = 0; i < count; i++) {
            colors.push('#2563eb');
        }
        return colors;
    }

    function getRankingData(tipo) {
        if (tipo === 'docentes') {
            return {
                labels: labelsDocentes,
                data: dataDocentes,
                label: 'Préstamos por docente'
            };
        } else if (tipo === 'carreras') {
            return {
                labels: labelsCarreras,
                data: dataCarreras,
                label: 'Préstamos por carrera'
            };
        } else if (tipo === 'herramientas') {
            return {
                labels: labelsHerramientas,
                data: dataHerramientas,
                label: 'Cantidad entregada por herramienta'
            };
        } else if (tipo === 'asignaturas') {
            return {
                labels: labelsAsignaturas,
                data: dataAsignaturas,
                label: 'Préstamos por asignatura / laboratorio'
            };
        } else if (tipo === 'autos') {
            return {
                labels: labelsAutos,
                data: dataAutos,
                label: 'Préstamos por llave de auto / vehículo'
            };
        } else if (tipo === 'panoleros') {
            return {
                labels: labelsPanoleros,
                data: dataPanoleros,
                label: 'Préstamos registrados por pañolero'
            };
        } else {
            return { labels: [], data: [], label: '' };
        }
    }

    const tipoRankingSelect = document.getElementById('tipoRanking');
    const inicial = getRankingData(tipoRankingSelect.value);

    const chartRanking = new Chart(ctxRanking, {
        type: 'bar',
        data: {
            labels: inicial.labels,
            datasets: [{
                label: inicial.label,
                data: inicial.data,
                backgroundColor: getBarColors(inicial.data.length),
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: true
                }
            },
            scales: {
                x: {
                    beginAtZero: true
                }
            }
        }
    });

    tipoRankingSelect.addEventListener('change', function() {
        const cfg = getRankingData(this.value);
        chartRanking.data.labels = cfg.labels;
        chartRanking.data.datasets[0].data = cfg.data;
        chartRanking.data.datasets[0].label = cfg.label;
        chartRanking.data.datasets[0].backgroundColor = getBarColors(cfg.data.length);
        chartRanking.update();
    });
</script>

</body>
</html>
